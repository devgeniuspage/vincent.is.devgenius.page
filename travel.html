<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì—¬í–‰ | Travel Dev</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <div class="brand">Travel Dev</div>
      <ul class="nav-links">
        <li><a href="/index.html">í™ˆ</a></li>
        <li><a href="/travel.html" class="active">ì—¬í–‰</a></li>
        <li><a href="/portfolio.html">ê°œë°œ í¬íŠ¸í´ë¦¬ì˜¤</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <section class="page-header">
      <h1>ì—¬í–‰ ì§€ë„</h1>
      <p>ì§€ë„ì—ì„œ ì—¬í–‰ì§€ë¥¼ íƒìƒ‰í•˜ê³  ë§ˆì»¤ë¥¼ í´ë¦­í•´ ë„ì‹œ/êµ­ê°€ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
    </section>

    <section class="map-section">
      <div id="map" class="map"></div>
    </section>

    <section id="flag-bar" class="flag-container"></section>

    <section class="page-header">
      <h2>ì—¬í–‰ ì¼ì •</h2>
      <p>ê¸°ê°„, ë„ì‹œ, êµ­ê°€ ì •ë³´ë¥¼ ì¹´ë“œë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>
    </section>
    <section id="travel-list" class="card-list"></section>
  </main>

  <footer class="site-footer">
    <small>Â© 2025 ì—¬í–‰í•˜ëŠ” ê°œë°œì</small>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <script>
    const map = L.map('map', { preferCanvas: true, worldCopyJump: true });
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    lightTiles.addTo(map);
    map.setView([20, 0], 2);

    function renderList(items){
      const listEl = document.getElementById('travel-list');
      if(!listEl) return;
      const sorted = items.slice().sort((a,b) => {
        const ap = (a.period||'').replace('.', '')
        const bp = (b.period||'').replace('.', '')
        return ap.localeCompare(bp) || (a.city||'').localeCompare(b.city||'');
      });
      listEl.innerHTML = '';
      sorted.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <p class="card-period">${it.period || '-'}</p>
          <h3 class="card-title">${it.city}, ${it.country} <span class="en-muted">${it.city_e}, ${it.country_e}</span></h3>
          <p class="card-task"></p>
        `;
        // ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë„ì‹œë¡œ í¬ì»¤ìŠ¤ ë° íŒì—…
        card.addEventListener('click', () => {
          try {
            const btn = document.querySelector(`.flag-btn[data-country="${it.country}"]`);
            if(btn) btn.click();
            const key = `${it.city}::${it.country}`;
            const marker = markerMap.get(key);
            if(marker){
              const ll = marker.getLatLng();
              map.flyTo(ll, Math.max(map.getZoom(), 6), { animate: true, duration: 0.8, easeLinearity: 0.25 });
              marker.openPopup();
            }
          } catch(e){ console.warn('ì¹´ë“œ í´ë¦­ ì²˜ë¦¬ ì˜¤ë¥˜:', e); }
        });
        listEl.appendChild(card);
      });
    }

    // Country flag emoji map (localized country names -> emoji)
    const FLAG_MAP = {
      'í˜ë£¨':'ğŸ‡µğŸ‡ª','ë³¼ë¦¬ë¹„ì•„':'ğŸ‡§ğŸ‡´','ë¯¸êµ­':'ğŸ‡ºğŸ‡¸','ì¹ ë ˆ':'ğŸ‡¨ğŸ‡±','ë¸Œë¼ì§ˆ':'ğŸ‡§ğŸ‡·','ì•„ë¥´í—¨í‹°ë‚˜':'ğŸ‡¦ğŸ‡·','ì¿ ë°”':'ğŸ‡¨ğŸ‡º',
      'íŠ€ë¥´í‚¤ì˜ˆ':'ğŸ‡¹ğŸ‡·','ë¶ˆê°€ë¦¬ì•„':'ğŸ‡§ğŸ‡¬','ë£¨ë§ˆë‹ˆì•„':'ğŸ‡·ğŸ‡´','í—ê°€ë¦¬':'ğŸ‡­ğŸ‡º','ì˜¤ìŠ¤íŠ¸ë¦¬ì•„':'ğŸ‡¦ğŸ‡¹','ì²´ì½”':'ğŸ‡¨ğŸ‡¿',
      'ë…ì¼':'ğŸ‡©ğŸ‡ª','ìŠ¤í˜ì¸':'ğŸ‡ªğŸ‡¸','í¬ë¥´íˆ¬ê°ˆ':'ğŸ‡µğŸ‡¹','ëŒ€í•œë¯¼êµ­':'ğŸ‡°ğŸ‡·','ì¼ë³¸':'ğŸ‡¯ğŸ‡µ'
    };
    const flagEmoji = (country) => FLAG_MAP[country] || 'ğŸ³ï¸';
    // ISO 3166-1 alpha-2 ì½”ë“œ ë§¤í•‘ (ì†Œë¬¸ì) -> FlagCDN SVG ì‚¬ìš©
    const COUNTRY_CODE_MAP = {
      'í˜ë£¨':'pe','ë³¼ë¦¬ë¹„ì•„':'bo','ë¯¸êµ­':'us','ì¹ ë ˆ':'cl','ë¸Œë¼ì§ˆ':'br','ì•„ë¥´í—¨í‹°ë‚˜':'ar','ì¿ ë°”':'cu',
      'íŠ€ë¥´í‚¤ì˜ˆ':'tr','ë¶ˆê°€ë¦¬ì•„':'bg','ë£¨ë§ˆë‹ˆì•„':'ro','í—ê°€ë¦¬':'hu','ì˜¤ìŠ¤íŠ¸ë¦¬ì•„':'at','ì²´ì½”':'cz',
      'ë…ì¼':'de','ìŠ¤í˜ì¸':'es','í¬ë¥´íˆ¬ê°ˆ':'pt','ëŒ€í•œë¯¼êµ­':'kr','ì¼ë³¸':'jp'
    };
    const flagImageUrl = (country) => {
      const code = COUNTRY_CODE_MAP[country];
      return code ? `https://flagcdn.com/${code}.svg` : '';
    };

    const markerMap = new Map(); // key: `${city}::${country}` -> marker
    let currentGroup = null;
    const countryGroups = new Map();
    const allGroup = L.layerGroup();
    const regionGroups = new Map();

    // Fit map view to a given layer group
    function fitMapToGroup(group){
      try{
        if(!group){
          map.setView([20, 0], 2);
          return;
        }
        // ìš°ì„  í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ì´ë©´ getBounds ì‚¬ìš©
        if(group.getBounds){
          const bounds = group.getBounds();
          if(bounds && bounds.isValid && bounds.isValid()){
            map.flyToBounds(bounds, { padding: [80, 80], maxZoom: 6, animate: true, duration: 0.9, easeLinearity: 0.25 });
            return;
          }
        }
        // ì¼ë°˜ ê·¸ë£¹ ì²˜ë¦¬
        const layers = group.getLayers ? group.getLayers() : [];
        if(!layers.length){ map.setView([20, 0], 2); return; }
        if(layers.length === 1){
          const ll = layers[0].getLatLng && layers[0].getLatLng();
          if(ll){ map.flyTo(ll, Math.max(map.getZoom(), 6), { animate: true, duration: 0.9, easeLinearity: 0.25 }); }
          else { map.setView([20, 0], 2); }
          return;
        }
        const points = layers.map(l => l.getLatLng && l.getLatLng()).filter(Boolean);
        const bounds = L.latLngBounds(points);
        if(bounds.isValid()){
          map.flyToBounds(bounds, { padding: [80, 80], maxZoom: 6, animate: true, duration: 0.9, easeLinearity: 0.25 });
        } else { map.setView([20, 0], 2); }
      }catch(e){
        console.warn('fitMapToGroup ì˜¤ë¥˜:', e);
        map.setView([20, 0], 2);
      }
    }

    function getFirstSpotForCountry(spots, country){
      const arr = spots.filter(s => s.country === country && Number.isFinite(s.lat) && Number.isFinite(s.lng));
      arr.sort((a,b) => {
        const ap = (a.period||'').replace(/\./g, '');
        const bp = (b.period||'').replace(/\./g, '');
        return ap.localeCompare(bp) || (a.city||'').localeCompare(b.city||'');
      });
      return arr[0] || null;
    }

    function renderFlags(countries, spots){
      const container = document.getElementById('flag-bar');
      if(!container) return;
      container.innerHTML = '';

      // "ë‚˜ë¼ë³„ë¡œ ë³´ê¸°" íƒ€ì´í‹€ì„ ê¸°ì¡´ í—¤ë” ìŠ¤íƒ€ì¼ë¡œ ì¶”ê°€
      const mainHeader = document.createElement('section');
      mainHeader.className = 'page-header';
      const mainTitle = document.createElement('h2');
      mainTitle.textContent = 'ë‚˜ë¼ë³„ë¡œ ë³´ê¸°';
      mainHeader.appendChild(mainTitle);
      container.appendChild(mainHeader);

      // ëŒ€ë¥™ ê·¸ë£¹ ì •ì˜
      const REGION_ORDER = ['ì „ì²´','ì•„ì‹œì•„','ìœ ëŸ½','ë¶ì¤‘ë¯¸','ë‚¨ë¯¸','ì•„í”„ë¦¬ì¹´'];
      const REGION_COUNTRIES = {
        'ì „ì²´': countries.slice(), // travel.jsonì˜ ëª¨ë“  ë‚˜ë¼ í¬í•¨
        'ì•„ì‹œì•„': ['ëŒ€í•œë¯¼êµ­','ì¼ë³¸','íŠ€ë¥´í‚¤ì˜ˆ'],
        'ìœ ëŸ½': ['ë¶ˆê°€ë¦¬ì•„','ë£¨ë§ˆë‹ˆì•„','í—ê°€ë¦¬','ì˜¤ìŠ¤íŠ¸ë¦¬ì•„','ì²´ì½”','ë…ì¼','ìŠ¤í˜ì¸','í¬ë¥´íˆ¬ê°ˆ'],
        'ë¶ì¤‘ë¯¸': ['ë¯¸êµ­','ì¿ ë°”'],
        'ë‚¨ë¯¸': ['í˜ë£¨','ë³¼ë¦¬ë¹„ì•„','ì¹ ë ˆ','ë¸Œë¼ì§ˆ','ì•„ë¥´í—¨í‹°ë‚˜'],
        'ì•„í”„ë¦¬ì¹´': []
      };

      // ì „ì²´ ë²„íŠ¼ ì„¹ì…˜ ì œê±°: íƒ€ì´í‹€ ì—†ì´ ìƒë‹¨ì— ì „ì²´ ë²„íŠ¼ë§Œ ë°°ì¹˜
      /* ìƒë‹¨ 'ì „ì²´' êµ­ê¸°(ê¸€ë¡œë¸Œ ì•„ì´ì½˜) ìˆ¨ê¹€ ì²˜ë¦¬: ê¸°ì¡´ UI ë¸”ë¡ ë¹„í™œì„±í™”
      const allBar = document.createElement('div');
      allBar.className = 'flag-bar';
      const allItem = document.createElement('div');
      allItem.className = 'flag-item';
      allItem.dataset.country = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'flag-btn active';
      allBtn.dataset.country = '';
      allBtn.innerHTML = `<img class="flag-img flag-img-contain" src="https://w1.pngwing.com/pngs/981/571/png-transparent-globe-icon-world-icon-design-symbol-text-black-and-white-circle-line.png" alt="ì „ì²´" title="ì „ì²´"/>`;
      const allLabel = document.createElement('span');
      allLabel.className = 'flag-name';
      allLabel.dataset.country = '';
      allLabel.textContent = 'ì „ì²´';
      allLabel.setAttribute('role','button');
      allLabel.setAttribute('tabindex','0');
      allItem.appendChild(allBtn);
      allItem.appendChild(allLabel);
      allBar.appendChild(allItem);
      container.appendChild(allBar);
      */

      // ê° ëŒ€ë¥™ ì„¹ì…˜ ìƒì„±: ì´ì œ 'ì „ì²´'ë„ í¬í•¨
      REGION_ORDER.forEach(region => {
        const section = document.createElement('div');
        section.className = 'flag-section';
        section.dataset.region = region;
        
        const header = document.createElement('button');
        header.className = 'flag-section-title';
        header.setAttribute('type','button');
        header.setAttribute('aria-expanded','false');
        header.innerHTML = `<span class="title-text">${region}</span><span class="line"></span><span class="toggle-icon" aria-hidden="true">â–¼</span>`;
        header.style.cursor = 'pointer';
        const bar = document.createElement('div');
        bar.className = 'flag-bar collapsible';
        bar.setAttribute('hidden','');
      
        const list = region === 'ì „ì²´' ? countries.slice() : (REGION_COUNTRIES[region] || []);
        list.forEach(cty => {
          const item = document.createElement('div');
          item.className = 'flag-item';
          item.dataset.country = cty;
          const btn = document.createElement('button');
          btn.className = 'flag-btn';
          btn.dataset.country = cty;
          const imgSrc = flagImageUrl(cty);
          btn.innerHTML = imgSrc
            ? `<img class="flag-img flag-img-contain" src="${imgSrc}" alt="${cty} êµ­ê¸°" title="${cty}"/>`
            : '';
          const label = document.createElement('span');
          label.className = 'flag-name';
          label.dataset.country = cty;
          label.textContent = cty;
          label.setAttribute('role','button');
          label.setAttribute('tabindex','0');
          item.appendChild(btn);
          item.appendChild(label);
          bar.appendChild(item);
        });
      
        section.appendChild(header);
        section.appendChild(bar);
        container.appendChild(section);
      });

      // ëŒ€ë¥™ ê·¸ë£¹(LayerGroup) êµ¬ì„±: êµ­ê°€ ê·¸ë£¹ì„ í•©ì³ ìƒì„± ('ì „ì²´'ëŠ” allGroup ì‚¬ìš©)
      REGION_ORDER.forEach(region => {
        let regGroup;
        if(region === 'ì „ì²´'){
          regGroup = allGroup;
        } else {
          regGroup = L.layerGroup();
          const countriesInRegion = REGION_COUNTRIES[region] || [];
          countriesInRegion.forEach(cty => {
            const grp = countryGroups.get(cty);
            if(grp && grp.getLayers){
              grp.getLayers().forEach(layer => regGroup.addLayer(layer));
            }
          });
        }
        regionGroups.set(region, regGroup);
      });

      function setRegionActive(region){
        const titles = container.querySelectorAll('.flag-section-title');
        titles.forEach(t => {
          const name = t.querySelector('.title-text')?.textContent?.trim() || '';
          if(name === (region||'')) t.classList.add('active');
          else t.classList.remove('active');
        });
      }

      function setActive(country){
        const buttons = container.querySelectorAll('.flag-btn');
        buttons.forEach(b => {
          if((b.dataset.country||'') === (country||'')) b.classList.add('active');
          else b.classList.remove('active');
        });
      }

      function applyRegionFilter(region){
        // ëŒ€ë¥™ ê·¸ë£¹ ì„ íƒ
        const nextGroup = regionGroups.get(region);
        if(!nextGroup){ return; }
        if(currentGroup){ map.removeLayer(currentGroup); }
        nextGroup.addTo(map);
        currentGroup = nextGroup;

        // ë¦¬ìŠ¤íŠ¸ í•„í„°ë§: í•´ë‹¹ ëŒ€ë¥™ì˜ êµ­ê°€ë§Œ
        const countriesInRegion = REGION_COUNTRIES[region] || [];
        const filtered = spots.filter(s => countriesInRegion.includes(s.country));
        renderList(filtered);
        // íƒ€ì´í‹€ í™œì„±í™”, êµ­ê°€ í™œì„±í™” í•´ì œ
        setRegionActive(region);
        setActive('');
        // ë§µ ë²”ìœ„ ë§ì¶¤
        fitMapToGroup(currentGroup);
        // ì„¹ì…˜ í† ê¸€: í´ë¦­í•œ ëŒ€ë¥™ë§Œ ì—´ê³ /ë‹«ê¸° (ë‹¤ë¥¸ ì„¹ì…˜ ìƒíƒœ ìœ ì§€)
        const targetSection = Array.from(container.querySelectorAll('.flag-section')).find(sec => (sec.dataset.region === region));
        if(targetSection) toggleRegion(targetSection);
      }

      function applyFilter(country){
        if(currentGroup){ map.removeLayer(currentGroup); }
        const nextGroup = country ? countryGroups.get(country) : allGroup;
        if(nextGroup){ nextGroup.addTo(map); }
        currentGroup = nextGroup || null;

        const filtered = country ? spots.filter(s => s.country === country) : spots;
        renderList(filtered);
        // êµ­ê°€ í™œì„±í™” ì²˜ë¦¬
        setActive(country || '');
        // í•´ë‹¹ êµ­ê°€ì˜ ëŒ€ë¥™ í™œì„±í™” ë˜ëŠ” 'ì „ì²´'
        const regionOfCountry = country
          ? (REGION_ORDER.find(r => r !== 'ì „ì²´' && (REGION_COUNTRIES[r] || []).includes(country)) || '')
          : 'ì „ì²´';
        setRegionActive(regionOfCountry);
        // ë§µ ë²”ìœ„ ë§ì¶¤
        fitMapToGroup(currentGroup);
      }

      function toggleRegion(section){
        const bar = section.querySelector('.flag-bar');
        const isOpen = bar && !bar.hasAttribute('hidden');
        if(isOpen){ closeSection(section); }
        else{ openSection(section); }
      }

      // ì´ˆê¸° ìƒíƒœ: ëª¨ë‘ ë‹«í˜(ë†’ì´ 0)
      container.querySelectorAll('.flag-section').forEach(sec => {
        const bar = sec.querySelector('.flag-bar');
        const icon = sec.querySelector('.toggle-icon');
        const titleEl = sec.querySelector('.flag-section-title');
        bar.setAttribute('hidden','');
        bar.style.height = '0px';
        sec.classList.remove('open');
        if(icon) icon.textContent = 'â–¼';
        if(titleEl) titleEl.setAttribute('aria-expanded','false');
      });
      // ìµœì´ˆ ë¡œë“œ ì‹œ 'ì „ì²´' ì„¹ì…˜ ì—´ê¸°
      const defaultSection = Array.from(container.querySelectorAll('.flag-section')).find(sec => sec.dataset.region === 'ì „ì²´');
      if(defaultSection) openSection(defaultSection);
      container.addEventListener('click', (e) => {
        const title = e.target.closest('.flag-section-title');
        if(title){
          const region = title.querySelector('.title-text')?.textContent?.trim() || title.textContent.replace(/(â–¼|â–²)/g,'').trim();
          applyRegionFilter(region);
          return;
        }
        const targetEl = e.target.closest('.flag-btn, .flag-name, .flag-item');
        if(!targetEl) return;
        const country = targetEl.dataset.country || '';
        applyFilter(country);
      });

      // í‚¤ë³´ë“œ ì ‘ê·¼ì„±: Enter/Spaceë¡œ ì œëª© í† ê¸€
      container.addEventListener('keydown', (e) => {
        const title = e.target.closest('.flag-section-title');
        if(title && (e.key === 'Enter' || e.key === ' ')){
          e.preventDefault();
          const region = title.querySelector('.title-text')?.textContent?.trim() || title.textContent.replace(/(â–¼|â–²)/g,'').trim();
          applyRegionFilter(region);
        }
        const label = e.target.closest('.flag-name');
        if(label && (e.key === 'Enter' || e.key === ' ')){
          e.preventDefault();
          const country = label.dataset.country || '';
          applyFilter(country);
        }
      });
    }

    fetch('/data/travel.json')
      .then(res => res.json())
      .then(spots => {
        const withCoords = spots.filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lng));

        // Build groups by country and allGroup
        withCoords.forEach(({ city, country, lat, lng }) => {
          const marker = L.marker([lat, lng]);
          marker.bindPopup(`<strong>${city}</strong><br/>${country}`);
          marker.bindTooltip(`${city}`, {permanent: false});
          allGroup.addLayer(marker);
          const key = `${city}::${country}`;
          markerMap.set(key, marker);
          if(country){
            const grp = countryGroups.get(country) || L.layerGroup();
            grp.addLayer(marker);
            countryGroups.set(country, grp);
          }
        });
        // Show all markers initially
        allGroup.addTo(map);
        currentGroup = allGroup;

        // Fit map to all markers initially
        fitMapToGroup(allGroup);

        // Render flags
        const countries = Array.from(new Set(spots.map(s => s.country).filter(Boolean))).sort();
        renderFlags(countries, spots);

        // Render full list initially
        renderList(spots);
      })
      .catch(err => console.error('ì—¬í–‰ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', err));
      // ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ í—¬í¼
      function openSection(section){
        const bar = section.querySelector('.flag-bar');
        const icon = section.querySelector('.toggle-icon');
        const titleEl = section.querySelector('.flag-section-title');
        if(!bar) return;
        bar.removeAttribute('hidden');
        const target = bar.scrollHeight;
        bar.style.height = '0px';
        requestAnimationFrame(() => {
          bar.style.height = `${target}px`;
        });
        const onEnd = () => {
          bar.style.height = '';
          bar.removeEventListener('transitionend', onEnd);
        };
        bar.addEventListener('transitionend', onEnd);
        section.classList.add('open');
        if(icon) icon.textContent = 'â–²';
        if(titleEl) titleEl.setAttribute('aria-expanded','true');
      }
      function closeSection(section){
        const bar = section.querySelector('.flag-bar');
        const icon = section.querySelector('.toggle-icon');
        const titleEl = section.querySelector('.flag-section-title');
        if(!bar) return;
        const start = bar.scrollHeight;
        bar.style.height = `${start}px`;
        requestAnimationFrame(() => {
          bar.style.height = '0px';
        });
        const onEnd = () => {
          bar.setAttribute('hidden','');
          bar.style.height = '';
          bar.removeEventListener('transitionend', onEnd);
        };
        bar.addEventListener('transitionend', onEnd);
        section.classList.remove('open');
        if(icon) icon.textContent = 'â–¼';
        if(titleEl) titleEl.setAttribute('aria-expanded','false');
      }
  </script>
</body>
</html>